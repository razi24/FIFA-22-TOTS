import pandas as pd
import os
import bs4
from bs4 import BeautifulSoup
import numpy as np
from pandas.core import series
import scipy as sc
import requests

from difflib import SequenceMatcher

# The function retures the similarity index between two names
def similar(a, b):
    return SequenceMatcher(None, a, b).ratio()


# Reading the files and creating the data frames to merge 
file_name='FIFA21.csv'
file_name1='Player Statistic 2021.csv'
#file_name='FIFA20.csv'
#file_name1='Player Statistic 2020.csv'

df_FIFA=pd.read_csv(file_name)
df_Stat=pd.read_csv(file_name1)
#print(df_FIFA,df_Stat)

# Definnig leagues and seasons
leagues = ['ESP 1', 'ENG 1', 'GER 1', 'ITA 1', 'FRA 1']
seasons = ['2019', '2020', '2021'] 

# Creating TOTS label 
tots_label=[0 for i in range(df_FIFA.shape[0])]
df_FIFA['tots']=tots_label
df_FIFA.loc[df_FIFA['tots']].loc[df_FIFA['Version'] == 'tots']=1
tots_player=list(df_FIFA.loc[df_FIFA['Version']=='tots']['Player'])



for i in range (df_FIFA.shape[0]) :

    if(df_FIFA.loc[i,'Player']  in tots_player):
        df_FIFA.loc[i,'tots']=1


# creating df for 5 big leagues
df_major_leagues=df_FIFA.loc[df_FIFA['League'].isin(leagues)]
df_copy_major=df_major_leagues.copy()

# creating special cards column
df_copy_major['special cards']=[i for i in range(df_copy_major.shape[0])]
df_copy_major.set_index(pd.Index(list(df_copy_major['special cards'])),inplace=True)
for i in range(df_copy_major.shape[0]):
    df_copy_major.loc[i,'special cards']=list(df_copy_major['Player']).count(df_copy_major.loc[i,'Player'])-1



# dropping duplicated cards for players 
df_copy_major.drop_duplicates(subset=['Player','Team'],keep='last',inplace=True)
df_copy_major.reset_index(inplace=True)


#removing signs from player names


# matching the Teams Names's between the two data frames
list_team_fifa=list(df_copy_major.Team.unique())


list_stat=list(df_Stat.Team.unique())

combained_list=list(set(list_stat+list_team_fifa))
differnces=list(set(combained_list)-set(list_team_fifa))

for i in range(len(differnces)):
    league_i=df_Stat.loc[df_Stat['Team']==differnces[i]].copy()
    league_i.reset_index(inplace=True)
    league_2=league_i.loc[0,'League']
    df_team=list((df_copy_major.loc[df_copy_major['League']==league_2])['Team'].unique())
    
    range_value=0.1
    new_value='a'
    for j in range(len(df_team)):
        #print(differnces[i],df_team[j])
        check_value= similar(differnces[i],df_team[j])
        if(check_value>range_value):
            range_value=check_value
            new_value=df_team[j]

    #print('name team change :', differnces[i],'----->',new_value)
    df_Stat['Team'].replace(differnces[i],new_value,inplace=True)   



# matching the Teams Names's between the two data frames


#replacing problamtic names for players

df_combained_checked=pd.merge(df_copy_major,df_Stat)


problamatic_players=list(set(list(df_Stat['Player']))-set(list(df_combained_checked['Player'])))

#print(len(problamatic_players))


for i in range(len(problamatic_players)):



    team_i=df_Stat.loc[df_Stat['Player']==problamatic_players[i]].copy()
    team_i.reset_index(inplace=True)
    team_2=team_i.loc[0,'Team']
    
    df_player=list((df_copy_major.loc[df_copy_major['Team']==team_2])['Player'].unique())
    df_player2=list(df_Stat['Player'].unique())

    range_value=0.51
    new_value='a'

    for j in range(len(df_player)):
        check_value=similar(problamatic_players[i],df_player[j])
        if((check_value>range_value) & (not(df_player[j] in df_player2))):
            range_value=check_value
            new_value=df_player[j]

   
    if(new_value != 'a'):
        df_Stat['Player'].replace(problamatic_players[i],new_value,inplace=True)
        #print('name change :', problamatic_players[i],'----->',new_value)
    #else:
        #print("Can't find it in the fifa data frame check :" ,problamatic_players[i])        







#combining the stat and the fifa data frames
df_combained=pd.merge(df_copy_major,df_Stat)
problamatic_players2=list(set(list(df_Stat['Player']))-set(list(df_combained['Player'])))
df_combained.drop(labels=['Unnamed: 0','id','position'],axis=1,inplace=True)

print(df_combained.columns)
#print(len(problamatic_players2))

    
file_name1="FIFA 20 + Statistical data 2020.csv"
f=open(file_name1,'w')
df_combained.to_csv(path_or_buf=file_name1)
f.close()    
  



        


    
        


   


    

    








     

      
   
